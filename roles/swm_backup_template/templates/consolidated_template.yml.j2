---
# Consolidated ALPACA Commands Playbook
# Generated from CSV data - Total Systems: {{ csv_data | length }}
# Generated at: {{ ansible_date_time.iso8601 }}

- name: Create ALPACA Commands for All Systems
  hosts: {{ alpaca_api.host }}
  gather_facts: false
  
  vars:
    # ALPACA API Configuration
    ALPACA_Operator_API_Protocol: "{{ alpaca_api.protocol }}"
    ALPACA_Operator_API_Port: {{ alpaca_api.port }}
    ALPACA_Operator_API_Username: "{{ alpaca_api.username }}"
    ALPACA_Operator_API_Password: "{{ alpaca_api.password }}"
    ALPACA_Operator_API_Validate_Certs: {{ alpaca_api.tls_verify | lower }}

  tasks:
{% for row in csv_data %}
    - name: Create {{ sla_definitions[row.system_sla].name }} Backup Command - {{ row.system_name }}
      pcg.alpaca_operator.alpaca_command:
        system:
          systemName: "{{ row.system_name }}"
        command:
          name: "{{ sla_definitions[row.system_sla].name }} Backup Command - {{ row.system_name }}"
          state: present
          agentName: "{{ row.agent_name }}"
          processId: {{ sla_definitions[row.system_sla].command_defaults.processId }}
          parameters: "{{ sla_definitions[row.system_sla].command_defaults.parameters | replace('__SYSTEM_TYPE__', row.system_type) | replace('__HDB_NW_SID__', row.hdb_nw_sid) | replace('__SYSTEM_AZ__', row.system_az) }}"
          parametersNeeded: {{ sla_definitions[row.system_sla].command_defaults.parametersNeeded | lower }}
          disabled: {{ sla_definitions[row.system_sla].command_defaults.disabled | lower }}
          critical: {{ sla_definitions[row.system_sla].command_defaults.critical | lower }}
          autoDeploy: {{ sla_definitions[row.system_sla].command_defaults.autoDeploy | lower }}
          schedule:
            period: "{{ sla_definitions[row.system_sla].command_defaults.schedule.period }}"
            time: "{{ sla_definitions[row.system_sla].command_defaults.schedule.time }}"
            cronExpression: "{{ sla_definitions[row.system_sla].command_defaults.schedule.cronExpression }}"
            daysOfWeek: {{ sla_definitions[row.system_sla].command_defaults.schedule.daysOfWeek | to_json }}
          history:
            documentAllRuns: {{ sla_definitions[row.system_sla].command_defaults.history.documentAllRuns | lower }}
            retention: {{ sla_definitions[row.system_sla].command_defaults.history.retention }}
          timeout:
            type: "{{ sla_definitions[row.system_sla].command_defaults.timeout.type }}"
            value: {{ sla_definitions[row.system_sla].command_defaults.timeout.value }}
          escalation:
            mailEnabled: {{ sla_definitions[row.system_sla].command_defaults.escalation.mailEnabled | lower }}
            smsEnabled: {{ sla_definitions[row.system_sla].command_defaults.escalation.smsEnabled | lower }}
            mailAddress: "{{ sla_definitions[row.system_sla].command_defaults.escalation.mailAddress }}"
            smsAddress: "{{ sla_definitions[row.system_sla].command_defaults.escalation.smsAddress }}"
            minFailureCount: {{ sla_definitions[row.system_sla].command_defaults.escalation.minFailureCount }}
            triggers:
              everyChange: {{ sla_definitions[row.system_sla].command_defaults.escalation.triggers.everyChange | lower }}
              toRed: {{ sla_definitions[row.system_sla].command_defaults.escalation.triggers.toRed | lower }}
              toYellow: {{ sla_definitions[row.system_sla].command_defaults.escalation.triggers.toYellow | lower }}
              toGreen: {{ sla_definitions[row.system_sla].command_defaults.escalation.triggers.toGreen | lower }}
        apiConnection:
          host: "{{ alpaca_api.host }}"
          protocol: "{{ alpaca_api.protocol }}"
          port: {{ alpaca_api.port }}
          username: "{{ alpaca_api.username }}"
          password: "{{ alpaca_api.password }}"
          tls_verify: {{ alpaca_api.tls_verify | lower }}
      register: command_result_{{ loop.index }}

    - name: Display result for {{ row.system_name }}
      ansible.builtin.debug:
        msg: |
          Command Creation Result for {{ row.system_name }}:
          - SLA: {{ row.system_sla }} ({{ sla_definitions[row.system_sla].name }})
          - Status: {{ 'Created' if command_result_{{ loop.index }}.changed else 'Already exists' }}
          - System: {{ row.system_name }} | Agent: {{ row.agent_name }}
{% endfor %}

    - name: Display consolidated summary
      ansible.builtin.debug:
        msg: |
          Consolidated Command Creation Summary:
          - Total systems processed: {{ csv_data | length }}
          - SLA1 systems: {{ csv_data | selectattr('system_sla', 'equalto', 'SLA1') | list | length }}
          - SLA2 systems: {{ csv_data | selectattr('system_sla', 'equalto', 'SLA2') | list | length }}
          - SLA3 systems: {{ csv_data | selectattr('system_sla', 'equalto', 'SLA3') | list | length }}
          - SLA4 systems: {{ csv_data | selectattr('system_sla', 'equalto', 'SLA4') | list | length }} 
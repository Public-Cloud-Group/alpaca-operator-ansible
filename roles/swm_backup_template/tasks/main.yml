---
# SWM Backup Template Role - Main Tasks

- name: Validate CSV processor configuration
  ansible.builtin.assert:
    that:
      - csv_processor.input_file is defined
      - csv_processor.delimiter is defined
      - output_config.output_dir is defined
    fail_msg: "Required configuration variables are missing"
    success_msg: "CSV processor configuration is valid"

- name: Validate ALPACA API configuration
  ansible.builtin.assert:
    that:
      - ALPACA_Operator_API_Username is defined
      - ALPACA_Operator_API_Password is defined
    fail_msg: "Required ALPACA API variables are missing. Please set ALPACA_Operator_API_Username and ALPACA_Operator_API_Password"
    success_msg: "ALPACA API configuration is valid"

- name: Build ALPACA API configuration
  ansible.builtin.set_fact:
    alpaca_api:
      host: "{{ inventory_hostname }}"
      protocol: "{{ ALPACA_Operator_API_Protocol | default('https') }}"
      port: "{{ ALPACA_Operator_API_Port | default(8443) }}"
      username: "{{ ALPACA_Operator_API_Username }}"
      password: "{{ ALPACA_Operator_API_Password }}"
      tls_verify: "{{ ALPACA_Operator_API_Validate_Certs | default(false) }}"

- name: Determine if execution is on remote host
  ansible.builtin.set_fact:
    is_remote_execution: "{{ inventory_hostname != 'localhost' and inventory_hostname != '127.0.0.1' and inventory_hostname != ansible_connection | default('ssh') != 'local' }}"

- name: Clear any existing CSV file variables
  ansible.builtin.set_fact:
    csv_source_file: ""
    csv_target_file: ""

- name: Set CSV file paths
  ansible.builtin.set_fact:
    csv_source_file: "{{ csv_processor.input_file }}"
    csv_target_file: "{{ ('/tmp/swm_prod_' + ansible_date_time.epoch + '_' + (999999999 | random | string) + '.csv') if is_remote_execution else csv_processor.input_file }}"

- name: Copy CSV file to remote host
  ansible.builtin.copy:
    src: "{{ csv_processor.input_file }}"
    dest: "{{ csv_target_file }}"
    mode: '0644'
  when: is_remote_execution

- name: Check if CSV file exists
  ansible.builtin.stat:
    path: "{{ csv_target_file }}"
  register: csv_file_stat

- name: Fail if CSV file does not exist
  ansible.builtin.fail:
    msg: "CSV file not found: {{ csv_target_file }}"
  when: not csv_file_stat.stat.exists

- name: Update CSV processor configuration with target file path
  ansible.builtin.set_fact:
    csv_processor: "{{ csv_processor | combine({'input_file': csv_target_file}) }}"

- name: Display processing information
  ansible.builtin.debug:
    msg: |
      Starting CSV processing for SLA-based ALPACA command generation
      CSV Source File: {{ csv_source_file }}
      CSV Target File: {{ csv_target_file }}
      Remote Execution: {{ is_remote_execution }}
      Output Directory: {{ output_config.output_dir }}
      Template Directory: {{ template_config.template_dir }}

- name: Read and process CSV data
  include_tasks: process_csv.yml

- name: Validate CSV data
  include_tasks: validate_csv.yml
  when: processing_options.validate_data | default(true)

- name: Create output directory
  ansible.builtin.file:
    path: "{{ output_config.output_dir }}"
    state: directory
    mode: '0755'

- name: Generate individual command files
  include_tasks: generate_individual_commands.yml
  when: processing_options.generate_individual_files | default(true)

- name: Generate consolidated command file
  include_tasks: generate_consolidated_file.yml
  when: processing_options.generate_consolidated_file | default(true)

- name: Generate inventory file
  include_tasks: generate_inventory.yml
  when: processing_options.generate_inventory | default(true)

- name: Generate variables file
  include_tasks: generate_variables.yml
  when: processing_options.generate_variables | default(true)

- name: Generate README file
  include_tasks: generate_readme.yml
  when: processing_options.generate_readme | default(true)

- name: Clean up temporary CSV file on remote host
  ansible.builtin.file:
    path: "{{ csv_target_file }}"
    state: absent
  when: is_remote_execution

- name: Display generation summary
  ansible.builtin.debug:
    msg: |
      Template-based Command Generation Summary:
      - Total rows processed: {{ csv_data | length }}
      - SLA1 systems: {{ csv_data | selectattr('system_sla', 'equalto', 'SLA1') | list | length }}
      - SLA2 systems: {{ csv_data | selectattr('system_sla', 'equalto', 'SLA2') | list | length }}
      - SLA3 systems: {{ csv_data | selectattr('system_sla', 'equalto', 'SLA3') | list | length }}
      - SLA4 systems: {{ csv_data | selectattr('system_sla', 'equalto', 'SLA4') | list | length }}
      - Individual files generated: {{ individual_files_generated | default(0) }}
      - Consolidated file generated: {{ consolidated_file_generated | default(false) }}
      - Output directory: {{ output_config.output_dir }}
  when: csv_data is defined 
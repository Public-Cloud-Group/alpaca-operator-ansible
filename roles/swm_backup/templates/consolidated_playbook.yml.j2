---
# Consolidated ALPACA Commands Playbook
# Generated from CSV: {{ csv_processor.input_file }}
# Total Commands: {{ processed_commands | length }}

- name: Configure ALPACA Commands from CSV
  hosts: local
  gather_facts: false

  tasks:
{% for command in processed_commands %}
    - name: Configure ALPACA Command - {{ command.command.name }}
      pcg.alpaca_operator.alpaca_command:
        system:
          systemName: "{{ command.system.systemName }}"

        command:
          name: "{{ command.command.name }}"
          state: "{{ command.command.state }}"
          agentName: "{{ command.command.agentName }}"
          parameters: "{{ command.command.parameters }}"
          parametersNeeded: "{{ command.command.parametersNeeded }}"
          disabled: "{{ command.command.disabled }}"
          critical: "{{ command.command.critical }}"
          autoDeploy: "{{ command.command.autoDeploy }}"

          schedule:
            period: "{{ command.command.schedule.period }}"
            time: "{{ command.command.schedule.time }}"
            cronExpression: "{{ command.command.schedule.cronExpression }}"
            daysOfWeek: "{{ command.command.schedule.daysOfWeek }}"

          history:
            documentAllRuns: "{{ command.command.history.documentAllRuns }}"
            retention: "{{ command.command.history.retention }}"

          timeout:
            type: "{{ command.command.timeout.type }}"
            value: "{{ command.command.timeout.value }}"

          escalation:
            mailEnabled: "{{ command.command.escalation.mailEnabled }}"
            smsEnabled: "{{ command.command.escalation.smsEnabled }}"
            mailAddress: "{{ command.command.escalation.mailAddress }}"
            smsAddress: "{{ command.command.escalation.smsAddress }}"
            minFailureCount: "{{ command.command.escalation.minFailureCount }}"
            triggers:
              everyChange: "{{ command.command.escalation.triggers.everyChange }}"
              toRed: "{{ command.command.escalation.triggers.toRed }}"
              toYellow: "{{ command.command.escalation.triggers.toYellow }}"
              toGreen: "{{ command.command.escalation.triggers.toGreen }}"

        apiConnection:
          host: "{{ command.apiConnection.host }}"
          protocol: "{{ command.apiConnection.protocol }}"
          port: "{{ command.apiConnection.port }}"
          username: "{{ command.apiConnection.username }}"
          password: "{{ command.apiConnection.password }}"
          tls_verify: "{{ command.apiConnection.tls_verify }}"

{% endfor %}

# Summary:
# - Total Commands: {{ processed_commands | length }}
# - SLA Distribution:
#   * SLA 1: {{ processed_commands | selectattr('command.sla_info.level', 'equalto', 'SLA1') | list | length }}
#   * SLA 2: {{ processed_commands | selectattr('command.sla_info.level', 'equalto', 'SLA2') | list | length }}
#   * SLA 3: {{ processed_commands | selectattr('command.sla_info.level', 'equalto', 'SLA3') | list | length }}
# - Systems: {{ processed_commands | map(attribute='system.systemName') | unique | list | length }}
# - Agents: {{ processed_commands | map(attribute='command.agentName') | unique | list | length }}
# Generated: {{ ansible_date_time.iso8601 | default(lookup('pipe', 'date -u +%Y-%m-%dT%H:%M:%SZ')) }}
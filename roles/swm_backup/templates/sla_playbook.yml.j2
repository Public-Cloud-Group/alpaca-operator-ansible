---
# SLA {{ item }} Commands Playbook
# Generated from CSV: {{ csv_processor.input_file }}
# SLA Level: {{ item }} - {{ sla_definitions[item].name }}

- name: Configure ALPACA Commands with SLA {{ item }}
  hosts: local
  gather_facts: false

  vars:
    sla_commands: "{{ processed_commands | selectattr('command.sla_info.level', 'equalto', item) | list }}"

  tasks:
    - name: Configure ALPACA Commands with SLA {{ item }}
      pcg.alpaca_operator.alpaca_command:
        system:
          systemName: "{{ command_item.system.systemName }}"

        command:
          name: "{{ command_item.command.name }}"
          state: "{{ command_item.command.state }}"
          agentName: "{{ command_item.command.agentName }}"
          parameters: "{{ command_item.command.parameters }}"
          parametersNeeded: "{{ command_item.command.parametersNeeded }}"
          disabled: "{{ command_item.command.disabled }}"
          critical: "{{ command_item.command.critical }}"
          autoDeploy: "{{ command_item.command.autoDeploy }}"

          schedule:
            period: "{{ command_item.command.schedule.period }}"
            time: "{{ command_item.command.schedule.time }}"
            cronExpression: "{{ command_item.command.schedule.cronExpression }}"
            daysOfWeek: "{{ command_item.command.schedule.daysOfWeek }}"

          history:
            documentAllRuns: "{{ command_item.command.history.documentAllRuns }}"
            retention: "{{ command_item.command.history.retention }}"

          timeout:
            type: "{{ command_item.command.timeout.type }}"
            value: "{{ command_item.command.timeout.value }}"

          escalation:
            mailEnabled: "{{ command_item.command.escalation.mailEnabled }}"
            smsEnabled: "{{ command_item.command.escalation.smsEnabled }}"
            mailAddress: "{{ command_item.command.escalation.mailAddress }}"
            smsAddress: "{{ command_item.command.escalation.smsAddress }}"
            minFailureCount: "{{ command_item.command.escalation.minFailureCount }}"
            triggers:
              everyChange: "{{ command_item.command.escalation.triggers.everyChange }}"
              toRed: "{{ command_item.command.escalation.triggers.toRed }}"
              toYellow: "{{ command_item.command.escalation.triggers.toYellow }}"
              toGreen: "{{ command_item.command.escalation.triggers.toGreen }}"

        apiConnection:
          host: "{{ command_item.apiConnection.host }}"
          protocol: "{{ command_item.apiConnection.protocol }}"
          port: "{{ command_item.apiConnection.port }}"
          username: "{{ command_item.apiConnection.username }}"
          password: "{{ command_item.apiConnection.password }}"
          tls_verify: "{{ command_item.apiConnection.tls_verify }}"
      loop: "{{ sla_commands }}"
      loop_control:
        loop_var: command_item

# SLA {{ item }} Summary:
# - SLA Name: {{ sla_definitions[item].name }}
# - SLA Description: {{ sla_definitions[item].description }}
# - Total Commands: {{ sla_commands | length }}
# - Systems: {{ sla_commands | map(attribute='system.systemName') | unique | list | length }}
# - Agents: {{ sla_commands | map(attribute='command.agentName') | unique | list | length }}
# Generated: {{ ansible_date_time.iso8601 | default(lookup('pipe', 'date -u +%Y-%m-%dT%H:%M:%SZ')) }}
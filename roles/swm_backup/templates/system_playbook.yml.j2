---
# System {{ item }} Commands Playbook
# Generated from CSV: {{ csv_processor.input_file }}
# Environment: {{ processing_options.environment }}
# System: {{ item }}

- name: Configure ALPACA Commands for System {{ item }}
  hosts: local
  gather_facts: false

  vars:
    system_commands: "{{ processed_commands | selectattr('command.system.systemName', 'equalto', item) | list }}"

  tasks:
    - name: Configure ALPACA Commands for System {{ item }}
      pcg.alpaca_operator.alpaca_command:
        system:
          systemName: "{{ command_item.system.systemName }}"

        command:
          name: "{{ command_item.command.name }}"
          state: "{{ command_item.command.state }}"
          agentName: "{{ command_item.command.agentName }}"
          parameters: "{{ command_item.command.parameters }}"
          parametersNeeded: "{{ command_item.command.parametersNeeded }}"
          disabled: "{{ command_item.command.disabled }}"
          critical: "{{ command_item.command.critical }}"
          autoDeploy: "{{ command_item.command.autoDeploy }}"

          schedule:
            period: "{{ command_item.command.schedule.period }}"
            time: "{{ command_item.command.schedule.time }}"
            cronExpression: "{{ command_item.command.schedule.cronExpression }}"
            daysOfWeek: "{{ command_item.command.schedule.daysOfWeek }}"

          history:
            documentAllRuns: "{{ command_item.command.history.documentAllRuns }}"
            retention: "{{ command_item.command.history.retention }}"

          timeout:
            type: "{{ command_item.command.timeout.type }}"
            value: "{{ command_item.command.timeout.value }}"

          escalation:
            mailEnabled: "{{ command_item.command.escalation.mailEnabled }}"
            smsEnabled: "{{ command_item.command.escalation.smsEnabled }}"
            mailAddress: "{{ command_item.command.escalation.mailAddress }}"
            smsAddress: "{{ command_item.command.escalation.smsAddress }}"
            minFailureCount: "{{ command_item.command.escalation.minFailureCount }}"
            triggers:
              everyChange: "{{ command_item.command.escalation.triggers.everyChange }}"
              toRed: "{{ command_item.command.escalation.triggers.toRed }}"
              toYellow: "{{ command_item.command.escalation.triggers.toYellow }}"
              toGreen: "{{ command_item.command.escalation.triggers.toGreen }}"

        apiConnection:
          host: "{{ command_item.apiConnection.host }}"
          protocol: "{{ command_item.apiConnection.protocol }}"
          port: "{{ command_item.apiConnection.port }}"
          username: "{{ command_item.apiConnection.username }}"
          password: "{{ command_item.apiConnection.password }}"
          tls_verify: "{{ command_item.apiConnection.tls_verify }}"
      loop: "{{ system_commands }}"
      loop_control:
        loop_var: command_item
        label: "{{ command_item.command.name }}"

# System {{ item }} Summary:
# - Total Commands: {{ system_commands | length }}
# - SLA Distribution:
#   * SLA 1: {{ system_commands | selectattr('command.sla_info.level', 'equalto', '1') | list | length }}
#   * SLA 2: {{ system_commands | selectattr('command.sla_info.level', 'equalto', '2') | list | length }}
#   * SLA 3: {{ system_commands | selectattr('command.sla_info.level', 'equalto', '3') | list | length }}
# - Agents: {{ system_commands | map(attribute='command.agentName') | unique | list | length }}
# Generated: {{ ansible_date_time.iso8601 }}
---
- name: Prepare and configure ALPACA command for {{ csv.systemName }}
  set_fact:
    # playbook_filename: "command_{{ csv.systemName }}_{{ csv.agentName }}_{{ csv.systemSla }}_{{ command_index + 1 }}.yml"

    this:
      override:
        critical: "{{ vars['override'][csv.systemSla]['critical'] | default(omit) }}"
      system:
        systemName: "{{ csv.systemName | default(omit) }}"
      command:
        state: present
        name: "{{ command_template.name | replace('{{ csv.systemName }}', csv.systemName) }}" # The command name is dynamically generated by replacing the placeholder '{{ csv.systemName }}'
                                                                                              # in the SLA template with the actual system name. This allows the use of variables in SLA templates if needed.
        agentName: "{{ csv.agentName | default(omit) }}"
        processId: "{{ globals.processId | default(command_template.processId | default(omit)) }}"
        processCentralId: "{{ globals.processCentralId | default(command_template.processCentralId | default(omit)) }}"
        parameters: "{{ globals.parameters | default(command_template.parameters | default(omit)) }}"
        schedule: "{{ globals.schedule | default(command_template.schedule | default(omit)) }}"
        parametersNeeded: "{{ globals.parametersNeeded | default(command_template.parametersNeeded | default(omit)) }}"
        disabled: "{{ globals.disabled | default(command_template.disabled | default(omit)) }}"
        critical: "{{ globals.critical | default(this.override.critical | default(command_template.critical | default(omit))) }}" ###### <--- Todo: So müssen die Abfragen nun aussehen, damit die Prioritäten (globals > sla-override > defaults) eingehalten werden können
        autoDeploy: "{{ globals.autoDeploy | default(command_template.autoDeploy | default(omit)) }}"
        history: "{{ globals.history | default(command_template.history | default(omit)) }}"
        timeout: "{{ globals.timeout | default(command_template.timeout | default(omit)) }}"
        escalation: "{{ globals.escalation | default(command_template.escalation | default(omit)) }}"
      apiConnection:
        host: "{{ ALPACA_Operator_API_Host }}"
        protocol: "{{ ALPACA_Operator_API_Protocol }}"
        port: "{{ ALPACA_Operator_API_Port }}"
        username: "{{ ALPACA_Operator_API_Username }}"
        password: "{{ ALPACA_Operator_API_Password }}"
        tls_verify: "{{ ALPACA_Operator_API_Validate_Certs }}"

# - name: Generate command playbook
#   vars:
#     system: "{{ this.system }}"
#     command: "{{ this.command }}"
#   template:
#     src: command_playbook_template.yml.j2
#     dest: "{{ output_dir }}/{{ playbook_filename }}"
#     mode: '0644'

- name: Debug - Output test
  debug:
    msg: |
      this.override.critical: {{ this.override.critical | default(omit) }}
      this.command.critical: {{ this.command.critical | default(omit) }}

# - name: Debug - Output task content
#   debug:
#     msg: |
#       system: {{ this.system | to_nice_yaml }}
#       command: {{ this.command | to_nice_yaml }}
#       apiConnection: {{ this.apiConnection | to_nice_yaml }}

# - name: "Ensure command {{ this.command.name }} is configured"
#   pcg.alpaca_operator.alpaca_command:
#     system: "{{ this.system }}"
#     command: "{{ this.command }}"
#     apiConnection: "{{ this.apiConnection }}"
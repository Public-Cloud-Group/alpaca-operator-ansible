---
- name: "Merge command_definition with SLA and role command defaults (Ansible combine)"
  set_fact:
    merged_command: >-
      {{
        merged_definitions.command_defaults | default({})
        | combine(
            merged_definitions.service_levels[csv.systemSla].command_defaults | default({}),
            recursive=True
          )
        | combine(
            command_definition | default({}),
            recursive=True
          )
      }}

- name: "Debug: Show merged_command"
  debug:
    var: merged_command
    verbosity: 1

- name: Prepare and configure ALPACA command for {{ csv.systemName }}
  set_fact:
    system:
      systemName: "{{ csv.systemName | default(omit) }}"
    command:
      agentName: "{{ merged_command.agentName | default(csv.agentName | default(omit)) }}"
      name: "{{ merged_command.name | default(omit) }}"
      state: "{{ merged_command.state | default(omit) }}"
      processId: "{{ merged_command.processId | default(omit) }}"
      processCentralId: "{{ merged_command.processCentralId | default(omit) }}"
      parameters: "{{ merged_command.parameters | default(omit) }}"
      schedule: "{{ merged_command.schedule | default(omit) }}"
      parametersNeeded: "{{ merged_command.parametersNeeded | default(omit) }}"
      disabled: "{{ merged_command.disabled | default(omit) }}"
      critical: "{{ merged_command.critical | default(omit) }}"
      autoDeploy: "{{ merged_command.autoDeploy | default(omit) }}"
      history: "{{ merged_command.history | default(omit) }}"
      timeout: "{{ merged_command.timeout | default(omit) }}"
      escalation: "{{ merged_command.escalation | default(omit) }}"
    apiConnection:
      host: "{{ ALPACA_Operator_API_Host }}"
      protocol: "{{ ALPACA_Operator_API_Protocol }}"
      port: "{{ ALPACA_Operator_API_Port }}"
      username: "{{ ALPACA_Operator_API_Username }}"
      password: "{{ ALPACA_Operator_API_Password }}"
      tls_verify: "{{ ALPACA_Operator_API_Validate_Certs }}"

- name: "Replace each SLA variable in system, command, and apiConnection"
  set_fact:
    system: "{{ system | to_json | replace('{ ' + item.key + ' }', item.value) | from_json }}"
    command: "{{ command | to_json | replace('{ ' + item.key + ' }', item.value) | from_json }}"
    apiConnection: "{{ apiConnection | to_json | replace('{ ' + item.key + ' }', item.value) | from_json }}"
  loop: "{{ merged_definitions.service_levels[csv.systemSla].variables | default({}) | dict2items }}"

- name: "Replace each CSV variable in system, command, and apiConnection"
  set_fact:
    system: "{{ system | to_json | replace('{ ' + item.key + ' }', item.value) | from_json }}"
    command: "{{ command | to_json | replace('{ ' + item.key + ' }', item.value) | from_json }}"
    apiConnection: "{{ apiConnection | to_json | replace('{ ' + item.key + ' }', item.value) | from_json }}"
  loop: "{{ csv | default({}) | dict2items }}"

- name: "Debug: Show task content with actual variable values"
  debug:
    var: "{ 'system': system, 'command': command, 'apiConnection': apiConnection }"
    verbosity: 1

- name: "Ensure command {{ command.name }} is configured"
  pcg.alpaca_operator.alpaca_command:
    system: "{{ system }}"
    command: "{{ command }}"
    apiConnection: "{{ apiConnection }}"
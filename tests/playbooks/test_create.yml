- name: Test ALPACA Operator Configuration again test hosts
  hosts: test
  gather_facts: false

  tasks:
    - name: Ensure group "ansible_testing_group_01" exists
      pcg.alpaca_operator.alpaca_group:
        name: ansible_testing_group_01
        state: present
        apiConnection:
          host: "{{ ALPACA_Operator_API_Host }}"
          protocol: "{{ ALPACA_Operator_API_Protocol }}"
          port: "{{ ALPACA_Operator_API_Port }}"
          username: "{{ ALPACA_Operator_API_Username }}"
          password: "{{ ALPACA_Operator_API_Password }}"
          tls_verify: "{{ ALPACA_Operator_API_Validate_Certs }}"

    - name: Ensure agent "ansible_testing_agent_01" exists
      pcg.alpaca_operator.alpaca_agent:
        name: ansible_testing_agent_01
        description: My Test Agent 01
        ipAddress: 10.1.1.1
        location: virtual
        escalation:
          failuresBeforeReport: 1
          mailEnabled: False
          mailAddress: monitoring_1@pcg.io
          smsEnabled: True
          smsAddress: 0123456789
        #scriptGroupId: -1
        state: present
        apiConnection:
          host: "{{ ALPACA_Operator_API_Host }}"
          protocol: "{{ ALPACA_Operator_API_Protocol }}"
          port: "{{ ALPACA_Operator_API_Port }}"
          username: "{{ ALPACA_Operator_API_Username }}"
          password: "{{ ALPACA_Operator_API_Password }}"
          tls_verify: "{{ ALPACA_Operator_API_Validate_Certs }}"

    - name: Ensure agent "ansible_testing_agent_02" exists
      pcg.alpaca_operator.alpaca_agent:
        name: ansible_testing_agent_02
        description: My Test Agent 02
        ipAddress: 10.1.1.2
        location: virtual
        escalation:
          failuresBeforeReport: 2
          mailEnabled: True
          mailAddress: monitoring_2@pcg.io
          smsEnabled: False
          smsAddress: 0123456789
        #scriptGroupId: -1
        state: present
        apiConnection:
          host: "{{ ALPACA_Operator_API_Host }}"
          protocol: "{{ ALPACA_Operator_API_Protocol }}"
          port: "{{ ALPACA_Operator_API_Port }}"
          username: "{{ ALPACA_Operator_API_Username }}"
          password: "{{ ALPACA_Operator_API_Password }}"
          tls_verify: "{{ ALPACA_Operator_API_Validate_Certs }}"

    - name: Ensure agent "ansible_testing_agent_03" exists
      pcg.alpaca_operator.alpaca_agent:
        name: ansible_testing_agent_03
        description: My Test Agent 03
        ipAddress: 10.1.1.3
        location: virtual
        escalation:
          failuresBeforeReport: 2
          mailEnabled: True
          mailAddress: monitoring_3@pcg.io
          smsEnabled: True
          smsAddress: 0123456789
        #scriptGroupId: -1
        state: present
        apiConnection:
          host: "{{ ALPACA_Operator_API_Host }}"
          protocol: "{{ ALPACA_Operator_API_Protocol }}"
          port: "{{ ALPACA_Operator_API_Port }}"
          username: "{{ ALPACA_Operator_API_Username }}"
          password: "{{ ALPACA_Operator_API_Password }}"
          tls_verify: "{{ ALPACA_Operator_API_Validate_Certs }}"

    - name: Ensure system "ansible01" exists
      pcg.alpaca_operator.alpaca_system:
        name: ansible01
        description: Ansible Test System 01
        magicNumber: 59
        checksDisabled: False
        groupName: ansible_testing_group_01
        rfcConnection:
          type: instance
          host: ansible01-host
          instanceNumber: 42
          sid: ABC
          logonGroup: ansible01-lgroup
          username: rfc_myUser
          password: rfc_myPasswd
          client: 123
          sapRouterString: rfc_SAPRouter
          sncEnabled: False
        agents: # Any agent referenced in a command for this system must be declared here. Otherwise, Ansible may attempt to remove unlisted agents and fail during execution.
          - name: ansible_testing_agent_01
          - name: ansible_testing_agent_02
          - name: ansible_testing_agent_03
        variables: # 16.05.2025: Seems like something is currently modified within the API - Updating variable values is not working anymore.
          - name: <BKP_DATA_CLEANUP_INT2>
            value: "55"
          - name: <BKP_DATA_DEST1>
            value: "45"
          - name: <BKP_DATA_CLEANUP_INT>
            value: "12"
        state: present
        apiConnection:
          host: "{{ ALPACA_Operator_API_Host }}"
          protocol: "{{ ALPACA_Operator_API_Protocol }}"
          port: "{{ ALPACA_Operator_API_Port }}"
          username: "{{ ALPACA_Operator_API_Username }}"
          password: "{{ ALPACA_Operator_API_Password }}"
          tls_verify: "{{ ALPACA_Operator_API_Validate_Certs }}"

    - name: Ensure some system commands exist
      pcg.alpaca_operator.alpaca_command_set:
        system:
          systemName: ansible01
        commands:
          - name: "BKP: DB log sync 1"
            state: present
            agentName: ansible_testing_agent_01
            parameters: "-p GLTarch -s <BKP_LOG_SRC> -l 4 -d <BKP_LOG_DEST1> -r <BKP_LOG_DEST2> -b <BKP_LOG_CLEANUP_INT> -t <BKP_LOG_CLEANUP_INT2> -h DB_HOST"
            # processId: 801            # or
            processCentralId: 8990048   #
            schedule:
              period: every_5min
              time: "11:11:11"
              cronExpression: ""
              daysOfWeek:
                - monday
                - sunday
            parametersNeeded: false
            disabled: true
            critical: true
            history:
              documentAllRuns: false
              retention: 100
            autoDeploy: false
            timeout:
              type: default
              value: 10
            escalation:
              mailEnabled: true
              smsEnabled: true
              mailAddress: "monitoring_1@pcg.io"
              smsAddress: "0123456789-1"
              minFailureCount: 1
              triggers:
                everyChange: true
                toRed: false
                toYellow: false
                toGreen: true
    
          - name: "BKP: DB log sync 2"
            state: present
            agentName: ansible_testing_agent_02
            parameters: "-p GLTarch -s <BKP_LOG_SRC> -l 4 -d <BKP_LOG_DEST1> -r <BKP_LOG_DEST2> -b <BKP_LOG_CLEANUP_INT> -t <BKP_LOG_CLEANUP_INT2> -h DB_HOST"
            processCentralId: 8000039
            schedule:
              period: manually
              time: "12:12:12"
              cronExpression: ""
              daysOfWeek:
                - monday
                - wednesday
                - friday
                - sunday
            parametersNeeded: false
            disabled: true
            critical: true
            history:
              documentAllRuns: false
              retention: 200
            autoDeploy: false
            timeout:
              type: custom
              value: 20
            escalation:
              mailEnabled: true
              smsEnabled: true
              mailAddress: "monitoring_2@pcg.io"
              smsAddress: "0123456789-2"
              minFailureCount: 1
              triggers:
                everyChange: true
                toRed: false
                toYellow: false
                toGreen: true
          
          - name: "BKP: DB log sync 3"
            state: present
            agentName: ansible_testing_agent_03
            parameters: "-p GLTarch -s <BKP_LOG_SRC> -l 4 -d <BKP_LOG_DEST1> -r <BKP_LOG_DEST2> -b <BKP_LOG_CLEANUP_INT> -t <BKP_LOG_CLEANUP_INT2> -h DB_HOST"
            processId: 801
            schedule:
              period: cron_expression
              cronExpression: '0 */5 * * * ?'
            parametersNeeded: true
            disabled: true
            critical: true
            history:
              documentAllRuns: false
              retention: 300
            autoDeploy: true
            timeout:
              type: custom
              value: 30
            escalation:
              mailEnabled: true
              smsEnabled: true
              mailAddress: "monitoring_3@pcg.io"
              smsAddress: "0123456789-3"
              minFailureCount: 1
              triggers:
                everyChange: true
                toRed: false
                toYellow: false
                toGreen: true
        apiConnection:
          host: "{{ ALPACA_Operator_API_Host }}"
          protocol: "{{ ALPACA_Operator_API_Protocol }}"
          port: "{{ ALPACA_Operator_API_Port }}"
          username: "{{ ALPACA_Operator_API_Username }}"
          password: "{{ ALPACA_Operator_API_Password }}"
          tls_verify: "{{ ALPACA_Operator_API_Validate_Certs }}"
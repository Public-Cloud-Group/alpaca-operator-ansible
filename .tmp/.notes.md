# Dev Notes
## Known issues
- Sometimes the API returns "Agent is currently in use and cannot be deleted" even though the agent is no longer in use. However, deletion via the ALPACA UI works as expected.
  Manually removing commands and agent assignments via the ALPACA UI first also works.
## Operator REST API – Manual Calls
### Authenticate and get token
```bash
curl -k -X POST \
  'https://nightly03.lnwsoft.corp:8443/api/auth/login' \
  -H 'accept: application/json' \
  -H 'Content-Type: application/json' \
  -d '{
  "username": "pms*",
  "password": "pms"
}'
```
### Get list of groups (example with token)
```bash
curl -k -i -H 'accept: application/json' \
     -H 'Authorization: Bearer <your-token-here>' \
     'https://nightly03.lnwsoft.corp:8443/api/monitor/groups'
```
### Get list of agents
```bash
TOKEN=$(curl -sk -X POST \
  'https://nightly03.lnwsoft.corp:8443/api/auth/login' \
  -H 'accept: application/json' \
  -H 'Content-Type: application/json' \
  -d '{
        "username": "pms*",
        "password": "pms"
      }' | jq -r '.token')
curl -sk -i -H 'accept: application/json' \
     -H "Authorization: Bearer ${TOKEN}" \
  'https://nightly03.lnwsoft.corp:8443/api/agents' && echo ""
```
### Get list of systems
```bash
TOKEN=$(curl -sk -X POST \
  'https://nightly03.lnwsoft.corp:8443/api/auth/login' \
  -H 'accept: application/json' \
  -H 'Content-Type: application/json' \
  -d '{
        "username": "pms*",
        "password": "pms"
      }' | jq -r '.token')
curl -sk -i -H 'accept: application/json' \
     -H "Authorization: Bearer ${TOKEN}" \
  'https://nightly03.lnwsoft.corp:8443/api/systems' && echo ""
```
## Testing Environment (Docker)
To start a Fedora container with Ansible pre-installed, use the provided script:
```bash
chmod +x ./testing/start-container.sh
./testing/start-container.sh
```

This will launch Docker Desktop (macOS) and:
    - Start a Fedora-based container
    - Install basic packages and full Ansible
    - Mount this project folder for development und `/ansible` inside the container

Once inside the container, you’re ready to test modules and playbooks.

### Show module documentation

```bash
ansible-doc alpaca_agent
ansible-doc alpaca_command_set
ansible-doc alpaca_command
ansible-doc alpaca_group
ansible-doc alpaca_system
```

### Run a Playbook

```bash
ansible-playbook playbooks/test_create.yml --check -vvv
ansible-playbook playbooks/test_command.yml -vvv
ansible-playbook playbooks/test_delete.yml
```


### Testing Roles

clear && ansible-playbook ../ansible_collections/pcg/alpaca_operator/roles/swm_backup/example_playbook.yml

clear && ansible-playbook ../tests/playbooks/test_commands_hana_backup_role.yml